[TOC]

# 自动微分简介

---

在具体介绍自动微分技术之前，更多的内容可以参考[CSE599G1](http://dlsys.cs.washington.edu/schedule) 和 [Automatic Differentiation in Machine Learning: a Survey](https://arxiv.org/pdf/1502.05767.pdf)

对于现代深度学习框架而言，其都使用了一种技术——自动微分，这一技术能够很有效的实现深度学习过程，因为传统的BP算法在网络加深的过程中，会导致其计算过于复杂，容易出错，因此自动微分能够将此过程隐藏于用户视角之外。 

## 其它微分求解方法

### 手动求解法

手动求解方法实质上对应的是传统的BP算法，直接求解出梯度公式，然后编写代码，代入实际数值，得出真实的梯度。 因而如果需要修改模型，那么每次都需要修改对应的梯度求解算法，这显然极大增加了用户的代码编写量。 

### 数值微分法

此概念实际上是针对导数的定义而得出的：
$$
f'(x) = \lim_{h\rightarrow 0}\frac{f(x+h) - f(x)}{h}
$$
那么根据此定义，只需要对于$h$取一个很小的数值，那么就可以很方便地求解导数，并且可以对用户隐藏求解过程，用户只要给出目标函数和要求解的梯度变量，程序可以自动给出相应的梯度。 然后，显然采用这种计算方法，其计算量过大，并且会有相应的`round-foff error`和 `truncation error`，一般而言，数值微分法主要用于检验其它算法的正确性。 

### 符号微分法

符号微分是代替我们第一种手动求解法的过程，利用代数软件，实现微分的一些公式。实际上能够进行求解的数学表达式只能满足于可以利用其相应进行转换的，不能有编程语言中的循环结构和条件结构，即将问题转换为一个纯数学符号问题，利用现有的代数软件进行符号微分求解。然而，其要求是过于严苛的，而且有可能会造成`expression swell`问题，导致求解速度变慢。

## 自动微分算法

实际上，自动微分是一种介于符号微分和数值微分的方法： 数值微分强调一开始直接代入数值近似求解；符号微分强调直接对代数进行求解，最后才代入问题数值；自动微分将符号微分法应用于最基本的算子，比如常数，幂函数，指数函数，对数函数，三角函数等，然后代入数值，保留中间结果，最后再应用于整个函数。

其这样的设计方案：使得其基本能够完全向用户隐藏微分求解过程，由于它只对基本函数或常数运用符号微分法则，所以它可以灵活结合编程语言的循环结构，条件结构等，使用自动微分和不使用自动微分对代码总体改动非常小，并且由于它的计算实际是一种图计算，可以对其做很多优化，这也是为什么该方法在现代深度学习系统中得以广泛应用。自动微分在实现中有前向模式和反向模式两种实现方案，下面分别进行介绍： 

### 前向模式（Forward Mode)

前向模式从计算图的起点开始，沿着计算图边的方向依次向前计算，直到达到计算图的终点。在计算过程中，以自变量的值计算图中每个节点的值以及导数值，并保留中间结果，从而得到整个函数值和其导数值；实际上可以视作为一元复合函数从内向外求导。 

关于具体的实例，可以参考[前向实例](https://zhuanlan.zhihu.com/p/70302265)。

前向传播算法每次只能计算对一个自变量的偏导数，这对于n个一元函数而言，其映射为： $\R^n \rightarrow \R^m$，在这种情况下，需要计算对每个输入变量的偏导数，显然计算效率是很低的。 

### 反向模式（Reversed Mode）

与前向模式不同，反向模式的思路则是根据计算图从后向前计算，一次得到对每个中间变量节点的偏导数。 实际上和BP算法一样，对于计算图而言，一个节点要记住前向计算时所有节点的值，供反向计算使用，而不必重复计算。 如果要同时计算多个变量的偏导数，那么可以借助雅克比矩阵完成，对于节点$x_1,x_2,...,x_m$，每个节点都有直接后续节点$y_1,...,y_n$，那么映射函数： 
$$
\mathbf{x} \rightarrow \mathbf{y}
$$
其最终的相应计算的梯度为：
$$
\nabla_x f = (\frac{\partial y}{\partial x})^T\nabla_yf
$$
其中的$\frac{\partial y}{\partial x}$即为雅克比矩阵。 



问题1 ： 关于自动微分技术 ，目前主要有三种自动微分技术：

1. 以tensorflow 为代表的基于静态数据流图的转换，可利用静态编译技术对网络进行性能优化，但受制于数据流图的表达形式，不能灵活表达控制流
2. 以pytorch 为代表的基于动态图的转换，虽然可以使用户可以灵活的使用控制流。而其缺点是运行时开销高，且不能运行静态编译技术对计算图进行性能优化
3. 基于源码转换的通用数据微分，也就是MindSpore采用的技术